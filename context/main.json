{
  "projectName": "Coffee Shop Revenue Management Backend",
  "version": "1.0.0",
  "description": "A comprehensive NestJS backend service for managing a coffee shop's revenue with categories, products, orders, and revenue reporting capabilities",
  "purpose": "Provide a complete backend solution for coffee shop operations including product catalog management, order processing, and revenue analytics",
  
  "technologyStack": {
    "framework": "NestJS 11.0.1",
    "language": "TypeScript 5.7.3",
    "database": "PostgreSQL",
    "orm": "TypeORM 0.3.27",
    "validation": "class-validator 0.14.2",
    "transformation": "class-transformer 0.5.1",
    "documentation": "Swagger/OpenAPI (@nestjs/swagger 11.2.1)",
    "runtime": "Node.js"
  },

  "architecture": {
    "pattern": "Modular Monolith",
    "style": "RESTful API",
    "modules": [
      {
        "name": "Categories",
        "path": "src/categories",
        "purpose": "Manage product categories",
        "endpoints": 5,
        "contextFile": "context/category.json"
      },
      {
        "name": "Products",
        "path": "src/products",
        "purpose": "Manage products with soft delete and category relationships",
        "endpoints": 5,
        "contextFile": "context/product.json"
      },
      {
        "name": "Orders",
        "path": "src/orders",
        "purpose": "Manage orders with lifecycle and order details",
        "endpoints": 6,
        "contextFile": "context/order.json"
      },
      {
        "name": "Revenue",
        "path": "src/revenue",
        "purpose": "Generate revenue reports with payment method breakdown",
        "endpoints": 2,
        "contextFile": "context/revenue.json"
      },
      {
        "name": "User",
        "table": "users",
        "fields": ["id", "email", "passwordHash", "fullName", "phone", "role", "rewardPoints", "refreshTokenHash", "createdAt", "updatedAt"],
        "relationships": [
          {
            "type": "OneToMany",
            "target": "RewardTransaction",
            "property": "rewardTransactions"
          },
          {
            "type": "OneToMany",
            "target": "ContactMessage",
            "property": "contactMessages"
          }
        ]
      },
      {
        "name": "RewardTransaction",
        "table": "reward_transactions",
        "fields": ["id", "userId", "type", "points", "balanceAfter", "description", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "User",
            "foreignKey": "userId",
            "joinColumn": "@JoinColumn({ name: 'userId' })",
            "cascadeDelete": true
          }
        ]
      },
      {
        "name": "ContactMessage",
        "table": "contact_messages",
        "fields": ["id", "name", "email", "phone", "message", "status", "userId", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "User",
            "foreignKey": "userId",
            "joinColumn": "@JoinColumn({ name: 'userId' })",
            "nullable": true
          }
        ]
      },
      {
        "name": "Upload",
        "path": "src/upload",
        "purpose": "Handle secure file uploads for product images with validation and database tracking",
        "endpoints": 4,
      "OrderDetail → Product": "ManyToOne with eager loading (each order detail references one product)",
      "RewardTransaction → User": "ManyToOne (reward transactions belong to a user)",
      "ContactMessage → User": "ManyToOne nullable (contact message may be linked to a user)"
      },
      {
        "name": "Auth",
        "path": "src/auth",
        "purpose": "Handle user authentication, JWT token issuance, and session lifecycle",
        "endpoints": 6,
        "contextFile": "context/auth.json"
      },
      {
        "name": "Users",
        "path": "src/users",
        "purpose": "Provide persistence and domain logic for user accounts and reward balances",
        "endpoints": 0,
        "contextFile": "context/users.json"
      },
      {
        "name": "Rewards",
        "path": "src/rewards",
        "purpose": "Manage reward points, transaction history, and redemption offers",
        "endpoints": 4,
        "contextFile": "context/rewards.json"
      },
      {
        "name": "Contact",
        "path": "src/contact",
        "purpose": "Collect customer contact messages and expose admin review endpoints",
        "endpoints": 2,
        "contextFile": "context/contact.json"
      },
      {
        "name": "Stats",
        "path": "src/stats",
        "purpose": "Provide aggregated statistics for the admin dashboard",
        "endpoints": 3,
        "contextFile": "context/stats.json"
      }
    ],
    "sharedComponents": {
      "baseEntity": {
        "path": "src/common/entities/base.entity.ts",
        "purpose": "Abstract base class with common fields for all entities",
        "fields": [
          "id (auto-generated primary key)",
          "createdAt (auto-generated timestamp)",
          "updatedAt (auto-updated timestamp)",
          "createdBy (audit trail - user ID)",
          "updatedBy (audit trail - user ID)",
          "deletedAt (soft delete support)"
        ]
      },
      "enums": {
        "path": "src/enums",
        "files": [
          {
            "name": "product.enum.ts",
            "enums": ["ProductStatus"]
          },
          {
            "name": "order.enum.ts",
            "enums": ["OrderStatus", "PaymentMethod"]
          },
          {
            "name": "user.enum.ts",
            "enums": ["UserRole"]
          },
          {
            "name": "reward.enum.ts",
            "enums": ["RewardTransactionType"]
          },
          {
            "name": "contact.enum.ts",
            "enums": ["ContactStatus"]
          }
        ]
      }
    }
  },

  "databaseSchema": {
    "type": "PostgreSQL",
    "entities": [
      {
        "name": "Category",
        "table": "categories",
        "fields": ["id", "name", "description", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": []
      },
      {
        "name": "Product",
        "table": "products",
        "fields": ["id", "name", "description", "price", "image", "status", "categoryId", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "Category",
            "foreignKey": "categoryId",
            "joinColumn": "@JoinColumn({ name: 'categoryId' })",
            "eagerLoading": true
          }
        ]
      },
      {
        "name": "Order",
        "table": "orders",
        "fields": ["id", "customerName", "userId", "paymentMethod", "status", "cancellationReason", "createdAt", "updatedAt", "createdBy", "updatedBy"],
        "relationships": [
          {
            "type": "OneToMany",
            "target": "OrderDetail",
            "property": "orderDetails",
            "cascade": true
          }
        ]
      },
      {
        "name": "OrderDetail",
        "table": "order_details",
        "fields": ["id", "orderId", "productId", "quantity", "unitPrice", "subtotal", "createdAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "Order",
            "foreignKey": "orderId",
            "joinColumn": "@JoinColumn({ name: 'orderId' })",
            "cascadeDelete": true
          },
          {
            "type": "ManyToOne",
            "target": "Product",
            "foreignKey": "productId",
            "joinColumn": "@JoinColumn({ name: 'productId' })",
            "eagerLoading": true
          }
        ]
      },
      {
        "name": "FileUpload",
        "table": "file_uploads",
        "fields": ["id", "originalFilename", "savedFilename", "filepath", "filesize", "mimetype", "uploadedBy", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": []
      },
      {
        "name": "User",
        "table": "users",
        "fields": ["id", "email", "passwordHash", "fullName", "phone", "role", "rewardPoints", "refreshTokenHash", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "OneToMany",
            "target": "RewardTransaction",
            "property": "rewardTransactions"
          },
          {
            "type": "OneToMany",
            "target": "ContactMessage",
            "property": "contactMessages"
          }
        ]
      },
      {
        "name": "RewardTransaction",
        "table": "reward_transactions",
        "fields": ["id", "userId", "type", "points", "balanceAfter", "description", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "User",
            "foreignKey": "userId",
            "joinColumn": "@JoinColumn({ name: 'userId' })",
            "cascadeDelete": true
          }
        ]
      },
      {
        "name": "ContactMessage",
        "table": "contact_messages",
        "fields": ["id", "name", "email", "phone", "message", "status", "userId", "createdAt", "updatedAt", "createdBy", "updatedBy", "deletedAt"],
        "relationships": [
          {
            "type": "ManyToOne",
            "target": "User",
            "foreignKey": "userId",
            "joinColumn": "@JoinColumn({ name: 'userId' })",
            "nullable": true
          }
        ]
      }
    ],
    "relationshipSummary": {
      "Product → Category": "ManyToOne (each product belongs to one category)",
      "Order → OrderDetail": "OneToMany (each order has multiple order details)",
      "OrderDetail → Order": "ManyToOne with cascade delete (each order detail belongs to one order)",
      "OrderDetail → Product": "ManyToOne with eager loading (each order detail references one product)",
      "RewardTransaction → User": "ManyToOne (reward transactions belong to a user)",
      "ContactMessage → User": "ManyToOne nullable (contact messages optionally link to a user)"
    },
    "synchronization": "Enabled in non-production environments"
  },

  "apiDocumentation": {
    "framework": "Swagger/OpenAPI",
    "endpoint": "/api/docs",
    "url": "http://localhost:3000/api/docs",
    "features": [
      "Interactive API documentation",
      "Request/response schemas",
      "Example values for all DTOs",
      "Endpoint descriptions and tags",
      "Query parameter documentation"
    ]
  },

  "environmentVariables": {
    "required": [
      {
        "name": "DB_HOST",
        "description": "PostgreSQL database host",
        "default": "localhost"
      },
      {
        "name": "DB_PORT",
        "description": "PostgreSQL database port",
        "default": "5432"
      },
      {
        "name": "DB_USERNAME",
        "description": "PostgreSQL database username",
        "default": "postgres"
      },
      {
        "name": "DB_PASSWORD",
        "description": "PostgreSQL database password",
        "default": ""
      },
      {
        "name": "DB_NAME",
        "description": "PostgreSQL database name",
        "default": "coffee_shop"
      },
      {
        "name": "NODE_ENV",
        "description": "Environment (development/production)",
        "default": "development"
      },
      {
        "name": "PORT",
        "description": "Application port",
        "default": "3000"
      },
      {
        "name": "JWT_ACCESS_SECRET",
        "description": "Secret used to sign access tokens",
        "default": "changeThisAccessSecret"
      },
      {
        "name": "JWT_REFRESH_SECRET",
        "description": "Secret used to sign refresh tokens",
        "default": "changeThisRefreshSecret"
      },
      {
        "name": "JWT_ACCESS_EXPIRES_IN",
        "description": "Access token lifetime (e.g., 15m)",
        "default": "15m"
      },
      {
        "name": "JWT_REFRESH_EXPIRES_IN",
        "description": "Refresh token lifetime (e.g., 7d)",
        "default": "7d"
      }
    ],
    "configFile": ".env.example"
  },

  "howToRun": {
    "setup": [
      "1. Clone the repository",
      "2. Install dependencies: npm install",
      "3. Copy .env.example to .env and configure database credentials",
      "4. Ensure PostgreSQL is running",
      "5. Database will be auto-created and synchronized on first run"
    ],
    "commands": {
      "install": "npm install",
      "build": "npm run build",
      "start": "npm run start",
      "startDev": "npm run dev (with hot reload)",
      "startProd": "npm run start:prod",
      "test": "npm test",
      "testE2E": "npm run test:e2e",
      "lint": "npm run lint",
      "format": "npm run format"
    },
    "accessPoints": {
      "api": "http://localhost:3000",
      "swagger": "http://localhost:3000/api/docs"
    }
  },

  "developmentGuidelines": {
    "codeStyle": [
      "Follow NestJS best practices",
      "Use TypeScript strict mode",
      "Apply ESLint and Prettier formatting",
      "Write descriptive variable and function names"
    ],
    "architecture": [
      "All entities must extend BaseEntity",
      "Place all enums in src/enums/ directory",
      "Use centralized enum imports",
      "Follow module/controller/service pattern",
      "Use DTOs for all request/response data"
    ],
    "validation": [
      "Use class-validator decorators in DTOs",
      "Add @ApiProperty decorators for Swagger documentation",
      "Validate all user inputs",
      "Use proper HTTP status codes"
    ],
    "database": [
      "Use TypeORM decorators for entity definitions",
      "Leverage BaseEntity for common fields",
      "Use soft delete for products (deletedAt field)",
      "Define relationships with proper cascade options",
      "Use @JoinColumn decorator on ManyToOne side to specify foreign key column name",
      "Document all relationships in module-specific context files"
    ],
    "documentation": [
      "Update context files when making changes",
      "Add Swagger decorators to all endpoints",
      "Document business rules in context files",
      "Keep API documentation up to date"
    ]
  },

  "recentArchitecturalChanges": [
    {
      "change": "JWT Authentication, Rewards, Contact, and Stats modules",
      "date": "2025-10-31",
      "description": "Introduced authentication, reward management, contact handling, and admin dashboard analytics to align with frontend endpoints",
      "impact": [
        "Added Auth module with JWT access/refresh flow and profile management",
        "Created Users module with User entity, password hashing helpers, and reward balance storage",
        "Added Rewards module with RewardTransaction entity, balance endpoints, and redemption logic",
        "Added Contact module for public contact submissions and admin review with role guard",
        "Added Stats module providing dashboard metrics, sales trend data, and top product analytics",
        "Updated Orders module to award reward points when orders are marked as paid",
        "Configured global /api prefix and relocated Swagger UI to /api/docs",
        "Extended .env.example with JWT secrets and expiration settings"
      ],
      "files": [
        "src/auth/**/*",
        "src/users/**/*",
        "src/rewards/**/*",
        "src/contact/**/*",
        "src/stats/**/*",
        "src/orders/orders.controller.ts",
        "src/orders/orders.service.ts",
        "src/main.ts",
        "src/app.module.ts",
        ".env.example",
        "package.json"
      ]
    },
    {
      "change": "Foreign Key Relationships with @JoinColumn",
      "date": "2025-10-25",
      "description": "Added explicit @JoinColumn decorators to all ManyToOne relationships for better database schema control",
      "impact": [
        "Product entity: Added @JoinColumn({ name: 'categoryId' }) for category relationship",
        "OrderDetail entity: Added @JoinColumn({ name: 'orderId' }) for order relationship",
        "OrderDetail entity: Added @JoinColumn({ name: 'productId' }) for product relationship",
        "Improved database schema clarity and explicit foreign key column naming",
        "All context files updated with relationship documentation including joinColumn property"
      ],
      "files": [
        "src/products/entities/product.entity.ts",
        "src/orders/entities/order-detail.entity.ts",
        "context/product.json",
        "context/order.json"
      ]
    },
    {
      "change": "Database Migration to PostgreSQL",
      "date": "2025-10-25",
      "description": "Migrated from MySQL to PostgreSQL for better performance and features",
      "impact": [
        "Replaced mysql2 package with pg",
        "Updated TypeORM configuration to use postgres driver",
        "Changed default port from 3306 to 5432",
        "Updated .env.example with PostgreSQL configuration",
        "Changed datetime to timestamp in BaseEntity for PostgreSQL compatibility"
      ]
    },
    {
      "change": "Swagger/OpenAPI Integration",
      "date": "2025-10-25",
      "description": "Added comprehensive API documentation using Swagger",
      "impact": [
        "Installed @nestjs/swagger and swagger-ui-express",
        "Configured Swagger in main.ts",
        "Added @ApiProperty decorators to all DTOs",
        "Added @ApiTags, @ApiOperation, @ApiResponse decorators to all controllers",
        "Swagger UI accessible at /api endpoint"
      ]
    },
    {
      "change": "Enum Centralization",
      "date": "Previous refactoring",
      "description": "Moved all enum types to dedicated src/enums/ directory",
      "impact": [
        "Created src/enums/product.enum.ts for ProductStatus",
        "Created src/enums/order.enum.ts for OrderStatus and PaymentMethod",
        "Updated all imports across the codebase",
        "Single source of truth for enum definitions"
      ]
    },
    {
      "change": "Base Entity Pattern",
      "date": "Previous refactoring",
      "description": "Created abstract BaseEntity class with common fields",
      "impact": [
        "All entities extend BaseEntity",
        "DRY principle applied to common fields",
        "Consistent audit trail across all entities",
        "Centralized soft delete support"
      ]
    },
    {
      "change": "Context Documentation System",
      "date": "Previous refactoring",
      "description": "Created comprehensive JSON documentation for all modules",
      "impact": [
        "Created context/ directory with 6 JSON files",
        "Documented all entities, DTOs, endpoints, and business rules",
        "Serves as source of truth for module behavior",
        "Facilitates onboarding and maintenance",
        "Created CONTEXT_SYSTEM_GUIDE.md for AI agents"
      ]
    },
    {
      "change": "File Upload Module",
      "date": "2025-10-25",
      "description": "Added secure file upload module for product images with comprehensive validation and database tracking",
      "impact": [
        "Created Upload module at src/upload/ with controller, service, entity",
        "Added FileUpload entity to track all uploaded files",
        "Implemented 4 endpoints: POST /upload/image, GET /upload/images, GET /upload/image/:id, DELETE /upload/image/:id",
        "Added security features: file extension validation, MIME type validation, file size limit (5MB), filename sanitization",
        "Configured static file serving from uploads/ directory",
        "Added Multer configuration for file handling",
        "Created FILE_UPLOAD_INTEGRATION_GUIDE.md for Frontend integration",
        "Updated Swagger documentation with upload tag",
        "Installed @types/multer dev dependency",
        "Created context/upload.json for module documentation"
      ]
    }
  ],

  "contextFiles": {
    "main": "context/main.json (this file)",
    "overview": "context/overview.json",
    "guide": "CONTEXT_SYSTEM_GUIDE.md",
    "modules": [
      "context/category.json",
      "context/product.json",
      "context/order.json",
      "context/revenue.json",
      "context/upload.json",
      "context/auth.json",
      "context/users.json",
      "context/rewards.json",
      "context/contact.json",
      "context/stats.json"
    ],
    "usage": "AI agents should read main.json first, then consult module-specific context files. See CONTEXT_SYSTEM_GUIDE.md for detailed instructions on maintaining context files.",
    "updateGuidelines": "When making changes to entities, DTOs, endpoints, or business rules, update the corresponding context file(s). Add architectural changes to recentArchitecturalChanges array."
  },

  "keyFeatures": [
    "Complete CRUD operations for categories and products",
    "Order management with lifecycle (pending_payment → paid/cancelled)",
    "Authenticated customer flows with JWT access/refresh tokens",
    "Reward point accrual on paid orders and redemption handling",
    "Soft delete for products (preserves data)",
    "Revenue reporting with daily and range-based analytics",
    "Dashboard statistics for admin panels (sales trends, top products)",
    "Secure file upload for product images with validation",
    "Contact form capture with staff moderation",
    "Environment-based configuration and JWT expiry customization",
    "Comprehensive API documentation with Swagger",
    "Input validation with class-validator",
    "Audit trail support (createdBy/updatedBy)",
    "PostgreSQL database with TypeORM"
  ],

  "totalEndpoints": 37,
  "buildStatus": "Success",
  "lastUpdated": "2025-10-31"
}

